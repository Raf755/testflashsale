<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QRIS Dinamis → Statis</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .menu, .setting, .qris { margin-top: 20px; }
    #timer { color: red; font-weight: bold; margin-top: 10px; }
    canvas { margin-top: 10px; }
    button { margin: 5px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h2>Aplikasi QRIS Dinamis → Statis</h2>  <div id="menu" class="menu">
    <button onclick="showSetting()">Setting</button>
    <button onclick="showQris()">QRIS</button>
  </div>  <div id="setting" class="setting hidden">
    <h3>Setting</h3>
    <input type="file" id="upload" accept="image/*"><br>
    <img id="preview" src="" style="max-width:200px; display:none; margin-top:10px;">
    <textarea id="payload" placeholder="Payload QRIS" style="width:100%; height:100px; margin-top:10px;"></textarea><br>
    <button onclick="clearUpload()">Hapus</button>
    <button onclick="backToMenu()">Kembali</button>
  </div>  <div id="qris" class="qris hidden">
    <h3>Generate QRIS Statis</h3>
    <input type="number" id="nominal" placeholder="Masukkan nominal"><br>
    <button onclick="generateQris()">Generate</button>
    <canvas id="qrisCanvas"></canvas>
    <div id="timer"></div>
    <button id="doneBtn" class="hidden" onclick="resetQris()">Selesai</button>
    <button onclick="backToMenu()">Kembali</button>
  </div><script>
let countdown;
let payload = "";

function showSetting(){
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("setting").classList.remove("hidden");
}

function showQris(){
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("qris").classList.remove("hidden");
}

function backToMenu(){
  document.getElementById("setting").classList.add("hidden");
  document.getElementById("qris").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
}

function clearUpload(){
  document.getElementById("upload").value = "";
  document.getElementById("preview").style.display = "none";
  document.getElementById("payload").value = "";
  payload = "";
}

// upload & baca QR
const uploadInput = document.getElementById("upload");
const preview = document.getElementById("preview");

uploadInput.addEventListener("change", function(){
  const file = this.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(e){
      preview.src = e.target.result;
      preview.style.display = "block";

      const img = new Image();
      img.onload = function(){
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0, img.width, img.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if(code){
          document.getElementById("payload").value = code.data;
          payload = code.data;
          alert("Payload QRIS berhasil dibaca!");
        }else{
          alert("Gagal membaca QR, pastikan gambar jelas.");
        }
      };
      img.src = e.target.result;
    }
    reader.readAsDataURL(file);
  }
});

function generateQris(){
  payload = document.getElementById("payload").value.trim();
  const nominal = document.getElementById("nominal").value.trim();
  if(!payload){
    alert("Payload belum ada, upload QRIS dulu!");
    return;
  }
  if(!nominal){
    alert("Masukkan nominal!");
    return;
  }

  // sisipkan / ganti tag 54 (Amount)
  let newPayload = setTag54(payload, nominal);

  // hitung ulang CRC (tag 63)
  newPayload = setCRC(newPayload);

  // generate QR
  const canvas = document.getElementById("qrisCanvas");
  QRCode.toCanvas(canvas, newPayload, function (error) {
    if (error) alert("Gagal generate QR");
  });

  // tampilkan timer & tombol selesai
  startTimer();
  document.getElementById("doneBtn").classList.remove("hidden");
}

function setTag54(payload, nominal){
  // cari tag 54
  let regex = /54(\d{2})(\d*)/;
  if(regex.test(payload)){
    // replace
    payload = payload.replace(regex, function(match, len, val){
      let newVal = nominal;
      let newLen = (""+newVal).length.toString().padStart(2,'0');
      return "54"+newLen+newVal;
    });
  }else{
    // tambahkan sebelum CRC (63)
    let idx = payload.indexOf("6304");
    if(idx>-1){
      let part1 = payload.substring(0, idx);
      let part2 = payload.substring(idx);
      let newVal = nominal;
      let newLen = (""+newVal).length.toString().padStart(2,'0');
      payload = part1 + "54"+newLen+newVal + part2;
    }
  }
  return payload;
}

function setCRC(payload){
  // hapus CRC lama
  let base = payload.substring(0, payload.indexOf("6304"));
  let full = base + "6304";
  let crc = CRC16(full);
  return full + crc;
}

function CRC16(str){
  let crc = 0xFFFF;
  for (let pos = 0; pos < str.length; pos++) {
    crc ^= str.charCodeAt(pos) << 8;
    for (let i = 0; i < 8; i++) {
      if ((crc & 0x8000) !== 0) {
        crc = (crc << 1) ^ 0x1021;
      } else {
        crc <<= 1;
      }
      crc &= 0xFFFF;
    }
  }
  return crc.toString(16).toUpperCase().padStart(4,'0');
}

function startTimer(){
  clearInterval(countdown);
  let duration = 20*60; // 20 menit
  const display = document.getElementById("timer");

  countdown = setInterval(function(){
    let minutes = Math.floor(duration/60);
    let seconds = duration%60;
    display.textContent = `Sisa waktu: ${minutes}:${seconds.toString().padStart(2,'0')}`;
    duration--;
    if(duration<0){
      clearInterval(countdown);
      alert("QRIS hangus! Kembali ke form input.");
      resetQris();
    }
  }, 1000);
}

function resetQris(){
  clearInterval(countdown);
  document.getElementById("qrisCanvas").getContext('2d').clearRect(0,0,300,300);
  document.getElementById("timer").textContent = "";
  document.getElementById("nominal").value = "";
  document.getElementById("doneBtn").classList.add("hidden");
}
</script></body>
</html>