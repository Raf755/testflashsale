<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8">
  <title>QRIS Dinamis â†’ Statis</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    #menu button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    .hidden { display: none; }
    #timer { font-size: 18px; color: red; margin-top: 10px; }
    textarea { width: 90%; height: 100px; margin-top: 10px; }
    img { max-width: 200px; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="menu">
    <button onclick="showQRIS()">QRIS</button>
    <button onclick="showSetting()">Setting</button>
  </div>  <div id="setting" class="hidden">
    <h3>Upload QRIS Dinamis</h3>
    <input type="file" id="uploadQR" accept="image/*"><br>
    <canvas id="previewCanvas" class="hidden"></canvas>
    <img id="previewImg" class="hidden">
    <textarea id="payload" placeholder="Payload QRIS"></textarea><br>
    <button onclick="clearUpload()">Hapus</button><br><br>
    <button onclick="backMenu()">Kembali</button>
  </div>  <div id="qris" class="hidden">
    <h3>Generate QRIS Statis</h3>
    <input type="number" id="nominal" placeholder="Masukkan nominal"><br><br>
    <button onclick="generateQR()">Generate</button>
    <canvas id="canvasQR"></canvas>
    <div id="timer"></div>
    <button id="doneBtn" class="hidden" onclick="backToInput()">Selesai</button><br><br>
    <button onclick="backMenu()">Kembali</button>
  </div><script>
  let timerInterval;

  function showQRIS(){
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('qris').classList.remove('hidden');
  }

  function showSetting(){
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('setting').classList.remove('hidden');
  }

  function backMenu(){
    document.getElementById('menu').classList.remove('hidden');
    document.getElementById('setting').classList.add('hidden');
    document.getElementById('qris').classList.add('hidden');
    clearInterval(timerInterval);
    document.getElementById('timer').innerText = '';
    document.getElementById('doneBtn').classList.add('hidden');
  }

  function clearUpload(){
    document.getElementById('previewImg').classList.add('hidden');
    document.getElementById('previewCanvas').classList.add('hidden');
    document.getElementById('payload').value = '';
  }

  // ===== Upload & Decode QR =====
  document.getElementById('uploadQR').addEventListener('change', function(e){
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(){
      const img = new Image();
      img.onload = function(){
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img,0,0);
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if(code){
          document.getElementById('payload').value = code.data;
        } else {
          alert("QR tidak terbaca");
        }
        document.getElementById('previewImg').src = reader.result;
        document.getElementById('previewImg').classList.remove('hidden');
      }
      img.src = reader.result;
    }
    reader.readAsDataURL(file);
  });

  // ===== QRIS Generate =====
  function generateQR(){
    let payload = document.getElementById('payload').value.trim();
    let nominal = document.getElementById('nominal').value.trim();
    if(!payload || !nominal){ alert("Payload atau nominal kosong"); return; }

    payload = setTag01(payload, "12"); // POI Method 12
    payload = setTag54(payload, nominal);
    payload = setCRC(payload);

    const canvas = document.getElementById('canvasQR');
    QRCode.toCanvas(canvas, payload, function (error) {
      if (error) console.error(error);
    });

    startTimer();
    document.getElementById('doneBtn').classList.remove('hidden');
  }

  function backToInput(){
    document.getElementById('nominal').value = '';
    document.getElementById('canvasQR').getContext('2d').clearRect(0,0,300,300);
    clearInterval(timerInterval);
    document.getElementById('timer').innerText = '';
    document.getElementById('doneBtn').classList.add('hidden');
  }

  // ===== Timer 20 menit =====
  function startTimer(){
    let time = 20*60;
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      let m = Math.floor(time/60);
      let s = time%60;
      document.getElementById('timer').innerText = `Sisa waktu: ${m}:${s<10?"0"+s:s}`;
      if(time<=0){
        clearInterval(timerInterval);
        alert("QRIS hangus, silakan input ulang");
        backToInput();
      }
      time--;
    },1000);
  }

  // ===== EMV Utility Functions =====
  function setTag01(payload, val){
    return updateTag(payload,"01",val);
  }

  function setTag54(payload, nominal){
    let formatted = (""+nominal).padStart(1,'0');
    return updateTag(payload,"54", formatted);
  }

  function updateTag(payload, tag, val){
    // remove old tag if exist
    let regex = new RegExp(tag+"...*?(?=[0-9]{2}[0-9]{2}|6304|$)");
    payload = payload.replace(regex,"");
    let length = (""+val).length.toString().padStart(2,'0');
    let newTag = tag+length+val;
    // insert before 63 (CRC)
    let idx = payload.indexOf("6304");
    if(idx>-1){
      payload = payload.substring(0,idx)+newTag+payload.substring(idx);
    } else {
      payload += newTag;
    }
    return payload;
  }

  function setCRC(payload){
    let idx = payload.indexOf("6304");
    if(idx>-1){
      payload = payload.substring(0,idx);
    }
    payload += "6304";
    let crc = crc16(payload);
    return payload+crc;
  }

  function crc16(str){
    let crc = 0xFFFF;
    for (let i = 0; i < str.length; i++) {
      crc ^= str.charCodeAt(i) << 8;
      for (let j = 0; j < 8; j++) {
        if ((crc & 0x8000) !== 0) {
          crc = (crc << 1) ^ 0x1021;
        } else {
          crc <<= 1;
        }
        crc &= 0xFFFF;
      }
    }
    return crc.toString(16).toUpperCase().padStart(4,'0');
  }
</script></body>
</html>