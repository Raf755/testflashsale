<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QRIS Dinamis ‚Üí Statis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .page { display: none; }
    .page.active { display: block; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div class="max-w-xl mx-auto p-4 sm:p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">QRIS Dinamis ‚Üí Statis</h1>
      <button id="btnHome" class="text-sm text-blue-600 underline">Beranda</button>
    </header><!-- Home -->
<section id="home" class="page active">
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <button id="gotoQRIS" class="p-6 rounded-2xl bg-white shadow hover:shadow-md transition text-center">
      <div class="text-3xl mb-2">üí≥</div>
      <div class="font-semibold">QRIS</div>
      <p class="text-sm text-gray-500">Masukkan nominal & generate</p>
    </button>
    <button id="gotoSetting" class="p-6 rounded-2xl bg-white shadow hover:shadow-md transition text-center">
      <div class="text-3xl mb-2">‚öôÔ∏è</div>
      <div class="font-semibold">Setting</div>
      <p class="text-sm text-gray-500">Upload & simpan data QRIS</p>
    </button>
  </div>
</section>

<!-- Setting -->
<section id="setting" class="page">
  <div class="bg-white rounded-2xl shadow p-4 sm:p-6 space-y-4">
    <h2 class="text-xl font-semibold">Setting QRIS</h2>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Payload QRIS (teks EMV)</label>
      <textarea id="payload" class="w-full rounded-xl border-gray-300 focus:border-blue-500 focus:ring-blue-500 p-3 h-32" placeholder="Contoh: 00020101021226...6304ABCD"></textarea>
      <p class="text-xs text-gray-500">Tempelkan payload QRIS asli (atau otomatis terisi dari gambar QR).</p>
    </div>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Upload Gambar QRIS</label>
      <input id="file" type="file" accept="image/*" class="block w-full text-sm" />
      <div id="previewWrap" class="mt-3 hidden">
        <img id="preview" class="max-h-40 mx-auto rounded-lg border" alt="Preview QR" />
        <button id="btnHapusGambar" class="mt-3 px-3 py-2 rounded-lg bg-red-50 text-red-700 hover:bg-red-100">Hapus Gambar</button>
      </div>
      <div id="scanResult" class="text-xs text-emerald-600 font-mono mt-2 hidden"></div>
    </div>

    <div class="flex items-center gap-2">
      <button id="btnSimpanSetting" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Simpan</button>
      <button id="btnResetSetting" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">Reset</button>
    </div>
  </div>
</section>

<!-- QRIS Generate -->
<section id="qris" class="page">
  <div class="bg-white rounded-2xl shadow p-4 sm:p-6">
    <h2 class="text-xl font-semibold mb-4">Buat QRIS Statis dengan Nominal</h2>
    <div class="space-y-3">
      <div>
        <label class="block text-sm font-medium">Nominal (Rp)</label>
        <input id="nominal" type="number" min="1" step="1" class="w-full rounded-xl border-gray-300 focus:border-blue-500 focus:ring-blue-500 p-3" placeholder="cth: 25000" />
      </div>
      <div class="flex items-center gap-2">
        <button id="btnGenerate" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Generate</button>
        <button id="btnClear" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200">Bersihkan</button>
      </div>
    </div>

    <div id="result" class="mt-6 hidden">
      <div class="flex flex-col items-center gap-3">
        <div id="qr" class="bg-white p-3 rounded-xl border"></div>
        <div id="timer" class="text-red-600 font-semibold">20:00</div>
        <button id="btnSelesai" class="mt-2 px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Selesai</button>
        <details class="mt-2 w-full">
          <summary class="cursor-pointer text-sm text-gray-700">Lihat payload hasil</summary>
          <pre id="payloadHasil" class="mt-2 p-3 bg-gray-50 rounded-xl text-xs overflow-x-auto"></pre>
        </details>
      </div>
    </div>

    <div id="noPayloadWarn" class="mt-6 p-3 rounded-xl bg-red-50 text-red-700 hidden">
      Payload QRIS belum diisi. Buka menu <strong>Setting</strong> dan tempelkan payload Anda terlebih dahulu.
    </div>
  </div>
</section>

  </div>  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>  <script>
    function parseEMV(str) { /* sama seperti sebelumnya */ }
    function getMap(items) { /* sama */ }
    function buildEMV(map) { /* sama */ }
    function crc16ccitt(str) { /* sama */ }
    function toAmountString(rp) { /* sama */ }

    const store = { set(k,v){localStorage.setItem(k,JSON.stringify(v))}, get(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, del(k){localStorage.removeItem(k)} };

    const els = {
      pages:{ home:document.getElementById('home'), setting:document.getElementById('setting'), qris:document.getElementById('qris') },
      btnHome:document.getElementById('btnHome'),
      gotoQRIS:document.getElementById('gotoQRIS'),
      gotoSetting:document.getElementById('gotoSetting'),
      payload:document.getElementById('payload'),
      file:document.getElementById('file'),
      previewWrap:document.getElementById('previewWrap'),
      preview:document.getElementById('preview'),
      btnHapusGambar:document.getElementById('btnHapusGambar'),
      btnSimpanSetting:document.getElementById('btnSimpanSetting'),
      btnResetSetting:document.getElementById('btnResetSetting'),
      nominal:document.getElementById('nominal'),
      btnGenerate:document.getElementById('btnGenerate'),
      btnClear:document.getElementById('btnClear'),
      result:document.getElementById('result'),
      qr:document.getElementById('qr'),
      timer:document.getElementById('timer'),
      btnSelesai:document.getElementById('btnSelesai'),
      noPayloadWarn:document.getElementById('noPayloadWarn'),
      payloadHasil:document.getElementById('payloadHasil'),
      scanResult:document.getElementById('scanResult'),
    };

    function show(page){ Object.values(els.pages).forEach(p=>p.classList.remove('active')); els.pages[page].classList.add('active'); }

    function loadSetting(){
      els.payload.value = store.get('payload','');
      const img = store.get('qrImg',null);
      if(img){ els.preview.src=img; els.previewWrap.classList.remove('hidden'); } else { els.preview.src=''; els.previewWrap.classList.add('hidden'); }
    }

    els.btnHome.onclick=()=>show('home');
    els.gotoQRIS.onclick=()=>{show('qris'); refreshQRISPage();};
    els.gotoSetting.onclick=()=>{show('setting'); loadSetting();};

    els.file.onchange=async e=>{
      const f=e.target.files?.[0]; if(!f)return;
      const url=await fileToDataURL(f);
      store.set('qrImg',url);
      els.preview.src=url; els.previewWrap.classList.remove('hidden');
      // coba decode
      decodeQRFromFile(f);
    };

    els.btnHapusGambar.onclick=()=>{ store.del('qrImg'); els.preview.src=''; els.previewWrap.classList.add('hidden'); els.scanResult.classList.add('hidden'); };

    els.btnSimpanSetting.onclick=()=>{ store.set('payload',(els.payload.value||'').trim()); alert('Setting disimpan.'); };
    els.btnResetSetting.onclick=()=>{ els.payload.value=''; store.del('payload'); alert('Setting direset.'); };

    function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

    function decodeQRFromFile(file){
      const reader=new FileReader();
      reader.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          const canvas=document.createElement('canvas');
          canvas.width=img.width; canvas.height=img.height;
          const ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0);
          const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
          const code=jsQR(imageData.data,canvas.width,canvas.height);
          if(code){
            els.payload.value=code.data;
            store.set('payload',code.data);
            els.scanResult.textContent='Payload terdeteksi dari gambar: '+code.data.slice(0,40)+'...';
            els.scanResult.classList.remove('hidden');
          } else {
            els.scanResult.textContent='Gagal membaca QR dari gambar.';
            els.scanResult.classList.remove('hidden');
          }
        };
        img.src=reader.result;
      };
      reader.readAsDataURL(file);
    }

    // Timer & generate (sama seperti sebelumnya)
    let timerId=null, deadline=null;
    function refreshQRISPage(){ stopTimer(); els.result.classList.add('hidden'); els.qr.innerHTML=''; els.payloadHasil.textContent=''; }
    function startTimer(min=20){ deadline=Date.now()+min*60*1000; updateTimer(); timerId=setInterval(updateTimer,1000);} 
    function stopTimer(){ if(timerId){clearInterval(timerId);timerId=null;} }
    function updateTimer(){ const remain=Math.max(0,deadline-Date.now()); const m=Math.floor(remain/60000); const s=Math.floor((remain%60000)/1000); els.timer.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; if(remain<=0){stopTimer();alert('Waktu habis.');refreshQRISPage();} }

    els.btnGenerate.onclick=()=>{
      const base=(store.get('payload','')||'').trim(); if(!base){els.noPayloadWarn.classList.remove('hidden');return;}
      const rp=Number(els.nominal.value||0); if(!rp||rp<=0){alert('Nominal tidak valid');return;}
      let items=parseEMV(base); const map=getMap(items); map.set('01','12'); map.set('54',toAmountString(rp));
      const finalPayload=buildEMV(map);
      els.qr.innerHTML=''; new QRCode(els.qr,{text:finalPayload,width:240,height:240});
      els.result.classList.remove('hidden'); els.payloadHasil.textContent=finalPayload; stopTimer(); startTimer(20);
    };

    els.btnClear.onclick=()=>{ els.nominal.value=''; refreshQRISPage(); };
    els.btnSelesai.onclick=()=>{ stopTimer(); refreshQRISPage(); };

    loadSetting();
  </script></body>
</html>
